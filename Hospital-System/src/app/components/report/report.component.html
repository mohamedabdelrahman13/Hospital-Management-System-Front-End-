<section>
    <div class="my-2 d-flex justify-content-flex-start align-items-center">
        <label for="viewSelect" class="me-2">View by :</label>
        <select id="viewSelect" class="form-select w-25" [(ngModel)]="selectedView" (change)="updateStats(selectedView)">
          <option value="daily">Daily</option>
          <option value="monthly">Monthly</option>
        </select>
    </div> 
</section>

<!-- report Section -->

<div class="report-wrapper" #report>
    <!-- Header -->
    <header class="report-header">
      <div class="logo-title">
        <h1>Hospital Management System</h1>
        <p class="subtitle">Official Report</p>
      </div>
      <div class="report-info">
        <p><strong>Date:</strong> {{ today | date:'fullDate' }}</p>
        <p><strong>Generated By:</strong> Admin</p>
      </div>

    </header>
    <div class="text-center report-title">
       <h2>{{selectedView | titlecase}} Hospital Management Statistics Report</h2>
    </div>
  
    <!-- Section: Patient Registration Trends -->
    <section class="report-section">
      <h2>Patient Registration Trends</h2>
      <table class="report-table">
        <thead>
          <tr>
            <th *ngIf="this.selectedView === 'monthly'">Month</th>
            <th *ngIf="this.selectedView === 'daily'">Day</th>
            <th>Total Patients</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody>
          @for(item of patientsTrendStats; track $index ; let i = $index ; let f = $first){
            <tr>
            <td *ngIf="this.selectedView === 'daily'">{{item.time | date:'mediumDate'}}</td>
            <td *ngIf="this.selectedView === 'monthly'">{{item.time | date:'MMMM yyyy'}}</td>
            <td>{{item.numberOfPatients}}</td>
            @if( i < patientsTrendStats.length - 1){
              @if(f){
                <td class="text-success">{{item.percentage}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_up</mat-icon></td>
              }   
              @else if(patientsTrendStats[i].percentage > patientsTrendStats[i-1].percentage){
                <td class="text-success">{{item.percentage}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_up</mat-icon></td>
              }
              @else if(patientsTrendStats[i].percentage < patientsTrendStats[i-1].percentage){
                <td class="text-danger">{{item.percentage}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_down</mat-icon></td>
              }
              @else if(patientsTrendStats[i].percentage == patientsTrendStats[i-1].percentage){
                <td class="text-secondary">{{item.percentage}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_flat</mat-icon></td>
              }
              
            }
            @else {
              <td class="text-secondary">{{ item.percentage}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_flat</mat-icon> </td>
            }
          </tr>
          }
        </tbody>
      </table>
      <p class="summary fw-bold" *ngIf="selectedView === 'monthly'">
        Registrations have shown consistent growth with the highest increase in <span style="color: var(--primary-color);">{{this.heighestPatientRegisterationMonth |  date:'MMMM' }}</span>.
      </p>
      <p class="summary fw-bold" *ngIf="selectedView === 'daily'">
        Registrations have shown consistent growth with the highest increase in <span style="color: var(--primary-color);">{{this.heighestPatientRegisterationDay |  date:'mediumDate' }}</span>.
      </p>
    </section>
    <!-- Section: Patient Registration Trends -->
    



    <!-- Section: Appointment Distribution -->
    <section class="report-section">
      <h2>Appointments Distribution</h2>
      <table class="report-table">
        <thead>
          <tr>
            <th *ngIf="this.selectedView === 'daily'">Day</th>
            <th *ngIf="this.selectedView === 'monthly'">Month</th>
            <th>Appointments</th>
            <th>Percentage</th>
          </tr>
        </thead>
        <tbody>
          @for(item of appStats; track $index ; let i = $index ; let f = $first){
            <tr>
              <td *ngIf="this.selectedView === 'daily'">{{item.time | date:'mediumDate'}}</td>
              <td *ngIf="this.selectedView === 'monthly'">{{item.time | date:'MMMM yyyy'}}</td>
                <td>{{item.numberOfAppointments}}</td>
                @if( i < appStats.length - 1){
                  @if(f){
                    <td class="text-success">{{item.percentage}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_up</mat-icon></td>
                  }   
                  @else if(appStats[i].percentage > appStats[i-1].percentage){
                    <td class="text-success">{{item.percentage}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_up</mat-icon></td>
                  }
                  @else if(appStats[i].percentage < appStats[i-1].percentage){
                    <td class="text-danger">{{item.percentage}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_down</mat-icon></td>
                  }
                  @else if(appStats[i].percentage == appStats[i-1].percentage){
                    <td class="text-secondary">{{item.percentage}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_flat</mat-icon></td>
                  }
                  
                }
                @else {
                  <td class="text-secondary">{{ item.percentage}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_flat</mat-icon> </td>
                }
              </tr>
          }
        </tbody>
      </table>
      <p class="summary fw-bold" *ngIf="selectedView === 'monthly'">
        Appointments reached their peak during <span style="color: var(--primary-color);">{{this.heighestAppStatsMonth |  date:'MMMM' }}</span>.
      </p>
      <p class="summary fw-bold" *ngIf="selectedView === 'daily'">
        Appointments reached their peak during <span style="color: var(--primary-color);">{{this.heighestAppStatsDay |  date:'mediumDate' }}</span>.
      </p>
    </section>
    <!-- Section: Appointment Distribution -->
    
    
    
    
    
    <!-- Section: Revenue Distribution -->
    <section class="report-section">
      <h2>Revenue Distribution</h2>
      <table class="report-table">
        <thead>
          <tr>
            <th *ngIf="this.selectedView === 'daily'">Day</th>
            <th *ngIf="this.selectedView === 'monthly'">Month</th>
            <th>Revenue</th>
          </tr>
        </thead>
        <tbody>
          @for(item of revenueStats; track $index ; let i = $index ; let f = $first){
            <tr>
              <td *ngIf="this.selectedView === 'daily'">{{item.time | date:'mediumDate'}}</td>
              <td *ngIf="this.selectedView === 'monthly'">{{item.time | date:'MMMM yyyy'}}</td>
              @if( i < revenueStats.length - 1){     
                @if(f){
                  <td class="text-success">{{item.revenue | currency:'EGP'}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_up</mat-icon></td>
                }
                @else if(revenueStats[i].revenue > revenueStats[i-1].revenue){
                  <td class="text-success">{{item.revenue | currency:'EGP'}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_up</mat-icon></td>
                }
                @else if(revenueStats[i].revenue < revenueStats[i-1].revenue){
                  <td class="text-danger">{{item.revenue | currency:'EGP'}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_down</mat-icon></td>
                }
                @else if(revenueStats[i].revenue == revenueStats[i-1].revenue){
                  <td class="text-secondary">{{item.revenue | currency:'EGP'}} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_flat</mat-icon></td>
                }
              }
              @else {
                <td class="text-secondary">{{ item.revenue | currency:'EGP' }} <mat-icon class="ms-1" style="vertical-align: middle; font-size: 20px;">trending_flat</mat-icon> </td>
              }
            </tr>
          }
        </tbody>
      </table>
      <p class="summary fw-bold" *ngIf="selectedView === 'monthly'">
        Revenue reached its highest level in <span style="color: var(--primary-color);">{{this.heighestRevenueMonth |  date:'MMMM' }}</span>.
      </p>
      <p class="summary fw-bold" *ngIf="selectedView === 'daily'">
        Revenue reached its highest level in <span style="color: var(--primary-color);">{{this.heighestRevenueDay |  date:'mediumDate' }}</span>.
      </p>
    </section>
    <!-- Section: Revenue Distribution -->
    

    <section class="report-section">
      <h2>Other Statistics</h2>
      <ul class="stats-list fw-bold">
        <li><strong>Total number of Patients : </strong> <span style="color: var(--primary-color);">{{ patientsNumber }}</span></li>
        <li><strong>Available staff : </strong> <span style="color: var(--primary-color);">{{ staffNumber }}</span></li>
        <li><strong>Average treatment cost : </strong> <span style="color: var(--primary-color);">{{ averageCost | currency:'EGP' }}</span></li>
      </ul>
    </section>
  


    <!-- Footer -->
    <footer class="report-footer">
      <p>Â© 2025 Hospital Management System | Confidential Report</p>
    </footer>
  </div>


  <div class="text-center">
    <button class="btn" (click)="exportPDF()">Export as PDF</button>
  </div>